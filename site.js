const STRIPE_PK = "pk_live_51RxKri0H8PCCsoV6l5oibeWA3aDIH2CHzg7OacCj7A9Jfhwm6EVQiqwuBJ06JForvf6feb1MC6S9kQ35RKF91DS900bdb58qgu";let stripe;document.addEventListener('DOMContentLoaded',()=>{if(window.Stripe)stripe=Stripe(STRIPE_PK);renderCatalog();renderReviews();});function money(n){return '$'+Number(n).toFixed(2);}async function loadJSON(p){const r=await fetch(p);return await r.json();}async function renderCatalog(){const root=document.querySelector('#catalog');if(!root)return;const items=await loadJSON('/assets/products.json');root.innerHTML='';items.forEach(p=>{const rem=Math.max(0,Number(p.fullPrice)-Number(p.downPayment));const m24=(rem/24).toFixed(2);const m36=(rem/36).toFixed(2);const el=document.createElement('article');el.className='product';el.innerHTML=`<img src="${p.image||'/assets/phone.svg'}" alt="${p.name}"/><div style="padding:8px"><div class="badge">Unlocked · Bring to your carrier</div><h3 style="margin:8px 0">${p.name}</h3><div class="price"><span style="text-decoration:line-through;color:#777">${money(p.fullPrice)}</span> &nbsp;<strong>${money(p.downPayment)}</strong> today</div><div class="price micro">24 mo: $${m24} · 36 mo: $${m36}</div><div style="margin-top:10px"><a class="btn primary" href="/checkout.html?id=${p.id}&type=down">Pay $${p.downPayment} Down</a><a class="btn alt" href="/checkout.html?id=${p.id}&type=full" style="margin-left:8px">Pay Full: ${money(p.fullPrice)}</a></div></div>`;root.appendChild(el);});}async function renderReviews(){const rroot=document.querySelector('#reviews');if(!rroot)return;const revs=await loadJSON('/assets/reviews.json');rroot.innerHTML='';revs.forEach(rv=>{const div=document.createElement('div');div.className='review';div.style.border='1px solid #ececf1';div.style.padding='12px';div.style.borderRadius='10px';div.innerHTML=`<div style="color:#EAB308">${'★'.repeat(Math.round(rv.rating))}</div><p><strong>${rv.name}</strong> <span style="color:#666">— verified customer</span></p><p>${rv.text}</p>`;rroot.appendChild(div);});}document.addEventListener('DOMContentLoaded',async()=>{if(!location.pathname.endsWith('checkout.html'))return;const qs=new URLSearchParams(location.search);const id=qs.get('id');const type=qs.get('type')||'down';const items=await loadJSON('/assets/products.json');const p=items.find(x=>x.id===id);const mount=document.querySelector('#checkout-page');if(!p){mount.innerHTML='<p>Product not found.</p>';return;}const rem=Math.max(0,Number(p.fullPrice)-Number(p.downPayment));const m24=(rem/24).toFixed(2);const m36=(rem/36).toFixed(2);mount.innerHTML=`<div style="padding:20px" class="container"><a href="/shop.html" class="btn alt">← Back to shop</a><div style="display:flex;gap:20px;margin-top:12px;flex-wrap:wrap"><div style="flex:1;min-width:280px"><img src="${p.image||'/assets/phone.svg'}" alt="${p.name}" style="max-width:360px"/><h2>${p.name}</h2><p style="color:#666">Unlocked · Refurbished (Excellent) · 90-day warranty</p></div><div style="width:320px"><div style="border:1px solid #ececf1;padding:12px;border-radius:10px"><h3>Order summary</h3><p>Price: <strong>${money(p.fullPrice)}</strong></p><p>Down payment: <strong>${money(p.downPayment)}</strong></p><p>24 mo: ${money(m24)} / 36 mo: ${money(m36)}</p><label for="plan">Plan length</label><select id="plan" style="width:100%;padding:8px;margin-top:8px"><option value="24">24 months</option><option value="36">36 months</option></select><div style="margin-top:12px"><button id="payBtn" class="btn primary">Continue to payment</button></div><p style="font-size:0.85rem;color:#666;margin-top:8px">You will be charged the selected amount at Stripe. Shipping and contact info will be collected during checkout.</p></div></div></div></div>`;document.getElementById('payBtn').addEventListener('click',async()=>{const plan=document.getElementById('plan').value;const body={productId:p.id,type:type,plan:Number(plan)};const res=await fetch('/.netlify/functions/create-checkout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});const data=await res.json();if(data.error){alert('Error: '+(data.error||'Unknown'));return;}if(stripe){await stripe.redirectToCheckout({sessionId:data.id});}else{alert('Stripe not loaded');}});});